#!/bin/bash
echo "--> Solving this damn permission issue once and for all..."

# Configura variáveis de ambiente CRÍTICAS
export PYTHONUSERBASE=${HOME}/.local
export PATH=${HOME}/.local/bin:${PATH}
export PIP_TARGET=${HOME}/.local

# Cria diretórios necessários
mkdir -p ${HOME}/app ${HOME}/.local/bin

# Copia a aplicação para onde TEMOS permissão
echo "--> Copying application to ${HOME}/app/"
cp -Rf /tmp/src/. ${HOME}/app/

# Vai para o diretório da aplicação
cd ${HOME}/app

echo "--> Installing Python packages with explicit user base..."
# FORÇA a instalação no diretório correto
pip install --user --no-cache-dir -r requirements.txt

echo "--> Verifying installations..."
${HOME}/.local/bin/pip list | grep -E "(Flask|gunicorn|psycopg2)"

echo "--> Application setup COMPLETED successfully!"