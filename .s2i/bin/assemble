#!/bin/bash
echo "--> FIXING THIS BULLSHIT ONCE AND FOR ALL..."

# PATHS ABSOLUTOS - SEM VARIÁVEIS
APP_DIR="/opt/app-root/myapp"
LOCAL_DIR="/opt/app-root/.local"

# Limpa e cria diretórios como ROOT se necessário, depois ajusta permissões
if [ $(whoami) = "root" ]; then
    echo "--> Running as root, setting up directories..."
    mkdir -p ${APP_DIR} ${LOCAL_DIR}
    chown -R 1001:0 /opt/app-root
    chmod -R g+rw /opt/app-root
else
    echo "--> Running as user, using existing directories..."
    # Usa diretórios que já devem existir
    mkdir -p ${APP_DIR} ${LOCAL_DIR} 2>/dev/null || true
fi

# Copia a aplicação
echo "--> Copying application..."
cp -Rf /tmp/src/. ${APP_DIR}/

# Vai para o diretório da aplicação
cd ${APP_DIR}

echo "--> Installing Python packages..."
# Instala SEM --user e SEM --target
pip install --no-cache-dir -r requirements.txt

echo "--> Verification..."
pip list | grep -E "(Flask|psycopg2)"

echo "--> SUCCESS! Application ready."